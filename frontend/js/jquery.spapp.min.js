!function ($) {
    $.spapp = function (options) {
        var settings, routes = {};

        settings = $.extend({
            defaultView: $("main#spapp > section:last-child").attr("id"),
            templateDir: "./tpl/",
            pageNotFound: false
        }, options);

        $("main#spapp > section").each(function (index, element) {
            var $element = $(this);
            routes[$element.attr("id")] = {
                view: $element.attr("id"),
                load: $element.data("load"),
                onCreate: function () {},
                onReady: function () {}
            };
        });

        this.route = function (route) {
            $.extend(routes[route.view], route);
        };

        var handleRouteChange = function () {
            var hash = location.hash.slice(1),
                route = routes[hash],
                $element = $("#" + hash);

            if ($element && route) {
                if ($element.hasClass("spapp-created")) {
                    route.onReady();
                } else {
                    $element.addClass("spapp-created");
                    if (route.load) {
                        $element.load(settings.templateDir + route.load, function () {
                            route.onCreate();
                            route.onReady();
                        });
                    } else {
                        route.onCreate();
                        route.onReady();
                    }
                }
            } else {
                if (settings.pageNotFound) {
                    window.location.hash = settings.pageNotFound;
                } else {
                    console.log(hash + " not defined");
                }
            }
        };

        this.run = function () {
            window.addEventListener("hashchange", function () {
                handleRouteChange();
            });

            if (window.location.hash) {
                handleRouteChange();
            } else {
                window.location.hash = settings.defaultView;
            }
        };

        return this;
    };
}(jQuery);
